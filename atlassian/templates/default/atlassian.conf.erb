LoadModule proxy_module /usr/lib/apache2/modules/mod_proxy.so
LoadModule proxy_http_module /usr/lib/apache2/modules/mod_proxy_http.so
LoadModule proxy_wstunnel_module /usr/lib/apache2/modules/mod_proxy_wstunnel.so

<VirtualHost *:80>
  ServerName <%= @params[:server_name] %>
  <% if @params[:server_aliases] && !@params[:server_aliases].empty? -%>
  ServerAlias <% @params[:server_aliases].each do |a| %><%= "#{a}" %> <% end %>
  <% end -%>

  Redirect permanent / https://<%= @params[:server_name] %>/
</VirtualHost>

<% if node[:deploy][@application_name][:ssl_support] -%>
  <VirtualHost *:443>
    ServerName <%= @params[:server_name] %>

    SSLEngine on
    SSLProxyEngine on
    SSLCertificateFile <%= node[:apache][:dir] %>/ssl/<%= @params[:server_name] %>.crt
    SSLCertificateKeyFile <%= node[:apache][:dir] %>/ssl/<%= @params[:server_name] %>.key
    <% if @params[:ssl_certificate_ca] -%>
      SSLCACertificateFile <%= node[:apache][:dir] %>/ssl/<%= @params[:server_name] %>.ca
    <% end -%>
    SetEnvIf User-Agent ".*MSIE.*" nokeepalive ssl-unclean-shutdown downgrade-1.0 force-response-1.0

    ProxyRequests Off
    ProxyPreserveHost On
    
    RewriteEngine On
    RewriteCond %{REQUEST_URI} !^/synchrony
    RewriteRule ^/(.*) http://127.0.0.1:<%= node[:deploy][@application_name][:port] %>/$1 [P]
    
    <Proxy *>
      Require all granted
    </Proxy>

    ProxyPass /synchrony http://127.0.0.1:8091/synchrony

    <Location /synchrony>
      Require all granted
      RewriteEngine on
      RewriteCond %{HTTP:UPGRADE} ^WebSocket$ [NC]
      RewriteCond %{HTTP:CONNECTION} Upgrade$ [NC]
      RewriteRule .* ws://127.0.0.1:8091%{REQUEST_URI} [P]
    </Location>
    
    ProxyPass / http://127.0.0.1:<%= node[:deploy][@application_name][:port] %>/
    ProxyPassReverse / http://127.0.0.1:<%= node[:deploy][@application_name][:port] %>/
    
    <Location />
      Require all granted
    </Location>
  </VirtualHost>
<% end -%>
